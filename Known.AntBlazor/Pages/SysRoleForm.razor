@inherits Blazor.SysRoleForm

<div class="role" style="display:flex;">
    <div class="role-form">
        <DataForm Model="Model" />
    </div>
    <div class="role-module">
        <div>模块</div>
        <AntTree Model="tree" />
    </div>
    <div class="role-button">
        <div>按钮</div>
        <CheckboxGroup Disabled="CheckDisabled" Options="allButtons" ValueChanged="OnButtonChanged" />
    </div>
    <div class="role-column">
        <div>栏位</div>
        <CheckboxGroup Disabled="CheckDisabled" Options="allColumns" ValueChanged="OnColumnChanged" />
    </div>
</div>

<style>
     .role-form {width:400px;padding-right:20px;}
     .role-module {width:260px;}
     .role-button {background-color:#f5f5f5;width:160px;}
     .role-column {background-color:#f1f1f1;width:160px;}
</style>

@code {
    private TreeModel tree;
    private Known.MenuItem current;
    private CheckboxOption[] allButtons = [];
    private CheckboxOption[] allColumns = [];
    private bool CheckDisabled => Model.IsView || current == null || !current.Checked;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        tree = new TreeModel
        {
            Checkable = true,
            IsView = Model.IsView,
            Data = Model.Data.Menus,
            DefaultCheckedKeys = Model.Data.MenuIds.ToArray(),
            OnNodeClick = OnTreeClick,
            OnNodeCheck = OnTreeCheck
        };
    }

    private void OnTreeClick(Known.MenuItem item)
    {
        SelectNode(item);
        InvokeAsync(StateHasChanged);
    }

    private void OnTreeCheck(Known.MenuItem item)
    {
        SelectNode(item);

        var btnItems = item.Checked ? allButtons.Select(o => o.Value).ToArray() : null;
        var colItems = item.Checked ? allColumns.Select(o => o.Value).ToArray() : null;
        allButtons.ForEach(o => o.Checked = item.Checked);
        allColumns.ForEach(o => o.Checked = item.Checked);
        OnButtonChanged(btnItems);
        OnColumnChanged(colItems);

        Model.Data.MenuIds.Remove(item.Id);
        if (item.Checked)
            Model.Data.MenuIds.Add(item.Id);
        InvokeAsync(StateHasChanged);
    }

    private void OnButtonChanged(string[] items)
    {
        Model.Data.MenuIds.RemoveAll(m => m.StartsWith($"b_{current.Id}"));
        if (items != null && items.Length > 0)
            Model.Data.MenuIds.AddRange(items);
    }

    private void OnColumnChanged(string[] items)
    {
        Model.Data.MenuIds.RemoveAll(m => m.StartsWith($"c_{current.Id}"));
        if (items != null && items.Length > 0)
            Model.Data.MenuIds.AddRange(items);
    }

    private void SelectNode(Known.MenuItem item)
    {
        current = item;
        allButtons = current.GetAllActions().ToCheckboxOptions(o =>
        {
            o.Checked = Model.Data.MenuIds.Contains(o.Value);
        });

        allColumns = current.GetAllColumns().ToCheckboxOptions(o =>
        {
            o.Checked = Model.Data.MenuIds.Contains(o.Value);
        });
    }
}